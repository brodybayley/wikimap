<d%- include('partials/_header') %>

<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <style>
      #map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script>
      // * 1. add coordinates to map as marker
      // 2. add title, description, image to marker infoWindow popup
      // 3. see what geocoding api returns (http request)
      // 4. extract coordinates, and image from geocoding api
      // 5. add in marker using custom title & description and extracted coords & img
      // 6. save created marker to database


      const addMarker = coords => {
        let marker = new google.maps.Marker({
          position: coords,
          map:map
        });
      };

      // let infoWindow = new google.maps.InfoWindow({
        //   content:'<h1>Hello</h1>'
        // });
        // marker.addListener('click', function() {
        //   infoWindow.open(map, marker);
        // });

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 8,
          center: { lat: -34.397, lng: 150.644 },
        });
        const geocoder = new google.maps.Geocoder();
        document.getElementById("submit").addEventListener("click", () => {
          geocodeAddress(geocoder, map);
        });
      }

      const addPoint = (result) => {
        const userId = req.params.userId;
        const mapId = req.params.map_id;
        const lat = results[0].geometry.location.latitude
        const long = results[0].geometry.location.longitude
        const title = results[0].address_components.formatted_address
        return db.query(`INSERT INTO POINTS (user_id, map_id, title, latitude, longitude)
         VALUES ($1, $2, $3, $4, $5)
         RETURNING *;`, [userId, mapId, title, latitude, longitude])
      }



      function geocodeAddress(geocoder, resultsMap) {
        const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === "OK") {
            console.log('results', results)
            addPoint(result);
            //results here is an object, containing a formatted address,
            //and a place_id.
            resultsMap.setCenter(results[0].geometry.location);
            new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location,
            });
          } else {
            alert(
              "Geocode was not successful for the following reason: " + status
            );
          }
        });
      }

      </script>
  </head>
  <body>
    <h1>Map Page</h1>
    <div id="floating-panel">
      <input id="address" type="textbox" value="Sydney, NSW" />
      <input id="submit" type="button" value="Find" />
    </div>
    <div id="map"></div>


    

    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
    <script
      async defer src="https://maps.googleapis.com/maps/api/js?key=<%=process.env.API_KEY %>&callback=initMap&libraries=&v=weekly"
      type="text/javascript"
    ></script>
  </body>
</html>